<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StudentService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">murasaki</a> &gt; <a href="index.source.html" class="el_package">com.backend.murasaki.services</a> &gt; <span class="el_source">StudentService.java</span></div><h1>StudentService.java</h1><pre class="source lang-java linenums">package com.backend.murasaki.services;

import com.backend.murasaki.dtos.*;
import com.backend.murasaki.exceptions.NotFoundException;
import com.backend.murasaki.models.*;
import com.backend.murasaki.repositories.LessonRepository;
import com.backend.murasaki.repositories.StudentRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Sort;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.lang.reflect.Array;
import java.util.*;
import java.util.regex.Pattern;
import java.util.stream.Collectors;

import org.springframework.data.domain.Pageable;

@Service
<span class="fc" id="L23">public class StudentService {</span>

    @Autowired
    private TeacherService teacherService;

    @Autowired
    private StudentRepository studentRepository;

    @Autowired
    private InterestService interestService;

    @Autowired
    private UserService userService;

    @Autowired
    private LessonRepository lessonRepository; // plantear mejor solucion para usar el service

    @Transactional
    public Student save(int user_id, StudentDTO dto) {
<span class="fc" id="L42">        User user = this.userService.findById(user_id);</span>
<span class="fc" id="L43">        Teacher teacher = this.teacherService.findById(user.getTeacher().getId());</span>
<span class="fc" id="L44">        List&lt;Integer&gt; interestIds = dto.getInterests().stream().map(Interest::getId).toList();</span>
<span class="pc bnc" id="L45" title="All 2 branches missed.">        Set&lt;Interest&gt; interests = this.interestService.findAll().stream().filter(interest -&gt; interestIds.stream().anyMatch(i -&gt; i == interest.getId())).collect(Collectors.toSet());</span>
<span class="fc" id="L46">        Student student = new Student(dto.getName(), dto.getJlptLevel(), teacher, dto.getPriorKnowledge(), dto.getAge(), dto.getTel(), dto.getEmail(), dto.getEmailTutor(), interests, new ArrayList&lt;&gt;());</span>
<span class="fc" id="L47">        this.studentRepository.save(student);</span>
<span class="fc" id="L48">        return student;</span>
    }

    @Transactional
    public Student update(int user_id, int student_id, StudentDTO dto){
<span class="fc" id="L53">        User userFound = this.userService.findById(user_id);</span>
<span class="fc" id="L54">        dto.setTeacherAsignedId(userFound.getTeacher().getId());</span>
<span class="fc" id="L55">        Student student = this.findById(student_id);</span>
<span class="fc" id="L56">        student.setAge(dto.getAge());</span>
<span class="fc" id="L57">        student.setEmail(dto.getEmail());</span>
<span class="fc" id="L58">        student.setName(dto.getName());</span>
<span class="fc" id="L59">        student.setEmailTutor(dto.getEmailTutor());</span>
<span class="fc" id="L60">        student.setJlptLevel(dto.getJlptLevel());</span>
<span class="fc" id="L61">        student.setPriorKnowledge(dto.getPriorKnowledge());</span>
<span class="fc" id="L62">        student.setTel(dto.getTel());</span>
<span class="pc bpc" id="L63" title="1 of 2 branches missed.">        if(student.getTeacherAssigned().getId() != dto.getTeacherAsignedId()){</span>
<span class="nc" id="L64">            Teacher teacher = this.teacherService.findById(dto.getTeacherAsignedId());</span>
<span class="nc" id="L65">            student.setTeacherAssigned(teacher);</span>
        }
<span class="fc" id="L67">        List&lt;Integer&gt; interestIds = dto.getInterests().stream().map(Interest::getId).toList();</span>
<span class="pc bnc" id="L68" title="All 2 branches missed.">        Set&lt;Interest&gt; interests = this.interestService.findAll().stream().filter(interest -&gt; interestIds.stream().anyMatch(i -&gt; i == interest.getId())).collect(Collectors.toSet());</span>
<span class="fc" id="L69">        student.setInterests(interests);</span>
<span class="fc" id="L70">        return student;</span>
    }

    @Transactional(readOnly = true)
    public List&lt;Student&gt; findAll() {
<span class="fc" id="L75">        return this.studentRepository.findAll();</span>
    }

    @Transactional(readOnly = true)
    public Student findById(int student_id) {
<span class="fc" id="L80">        return this.studentRepository.findById(student_id).orElseThrow(() -&gt; new NotFoundException(&quot;The requested Student was not found.&quot;));</span>
    }

    @Transactional(readOnly = true)
    public StudentDTO findByIdDTO(int student_id) {
<span class="fc" id="L85">        return this.findById(student_id).toDTO();</span>
    }

    @Transactional
    public Student addInterest(AddInterestDTO dto){
<span class="nc" id="L90">        Student student = this.findById(dto.getStudent_id());</span>
<span class="nc" id="L91">        Interest interest = this.interestService.findById(dto.getInterest_id());</span>
<span class="nc" id="L92">        student.addInterest(interest);</span>
<span class="nc" id="L93">        return this.studentRepository.save(student);</span>
    }

    @Transactional
    public Student addLesson(LessonDTO dto, int student_id){
<span class="fc" id="L98">        Student student = this.findById(student_id);</span>
<span class="pc" id="L99">        ArrayList&lt;Link&gt; links = new ArrayList&lt;Link&gt;(dto.getLinkDTOS().stream().map(dTo -&gt; new Link(dTo.getTitle(), dTo.getUrl())).toList());</span>
        //List&lt;Link&gt; links = dto.getLinkDTOS().stream().map(dTo -&gt; new Link(dTo.getTitle(), dTo.getUrl())).toList();
<span class="fc" id="L101">        Lesson lesson = new Lesson(dto.getDate(), dto.getLessonNumber(), dto.getContent(), dto.getHomework(), links);</span>
<span class="fc" id="L102">        this.lessonRepository.save(lesson);</span>
<span class="fc" id="L103">        student.addLesson(lesson);</span>
<span class="fc" id="L104">        return this.studentRepository.save(student);</span>
    }

    @Transactional(readOnly = true)
    public Page&lt;StudentDTOout&gt; find(int user_id, String search_text, int page, int size){
        //Pageable page = PageRequest.of(1, 2, Sort.by(&quot;name&quot;));
<span class="fc" id="L110">        Pageable p = PageRequest.of(page, size);</span>
        Page&lt;Student&gt; students;
<span class="fc" id="L112">        User user = this.userService.findById(user_id);</span>
<span class="pc bpc" id="L113" title="1 of 2 branches missed.">        if(this.isInteger(search_text)){</span>
<span class="nc" id="L114">            students = this.studentRepository.findByJlptLevelAndTeacherAssigned(p, Integer.parseInt(search_text), user.getTeacher());</span>
        }else{
<span class="fc" id="L116">            students = this.studentRepository.findByNameLikeAndTeacherAssigned(p,&quot;%&quot;+search_text+&quot;%&quot;, user.getTeacher());</span>
        }
<span class="fc" id="L118">        return students.map(student -&gt; new StudentDTOout(student.getId(), student.getName(), student.getJlptLevel(), student.getEmail(), student.getTel(), student.getTeacherAssigned().toDTO()));</span>
    }

    private boolean isInteger(String str){
<span class="fc" id="L122">        return Pattern.matches(&quot;-?[0-9]+&quot;, str);</span>
    }

    @Transactional
    public void delete(int student_id){
<span class="fc" id="L127">        Student student = this.findById(student_id);</span>
<span class="fc" id="L128">        this.studentRepository.delete(student);</span>
<span class="fc" id="L129">    }</span>

    @Transactional
    public void removeLesson(int student_id, int lesson_id){
<span class="nc" id="L133">        Student studentFound = this.findById(student_id);</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">        Lesson lessonFound = studentFound.getLessons().stream().filter(lesson -&gt; lesson.getId() == lesson_id).findFirst().orElseThrow(() -&gt; new NotFoundException(&quot;The requested Lesson was not found.&quot;));</span>
<span class="nc" id="L135">        studentFound.deleteLesson(lessonFound);</span>
<span class="nc" id="L136">        this.studentRepository.save(studentFound);</span>
<span class="nc" id="L137">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>